<div class="cajas-fisicas-page">
  <div class="page-header">
    <div class="icon-wrap"><mat-icon>business_center</mat-icon></div>
    <div class="title-wrap">
      <h2 class="title">{{ title }}</h2>
      <p class="subtitle">Gestión de cajas físicas</p>
    </div>
  </div>

  <div class="table-card">
    <header class="panel-header">
      <h3>DATOS</h3>
    </header>

    <div class="toolbar">
      <button
        mat-raised-button
        (click)="insertar()"
        [disabled]="editMode() || loading()"
        matTooltip="Insertar nueva caja física"
      >
        <mat-icon>add</mat-icon>
        Insertar
      </button>
      <button
        mat-raised-button
        color="warn"
        (click)="eliminar()"
        [disabled]="!selectedRow || editMode() || loading()"
        matTooltip="Eliminar caja física seleccionada"
      >
        <mat-icon>delete</mat-icon>
        Eliminar
      </button>
      <button
        mat-raised-button
        (click)="modificar()"
        [disabled]="!selectedRow || editMode() || loading()"
        matTooltip="Modificar caja física seleccionada"
      >
        <mat-icon>edit</mat-icon>
        Modificar
      </button>
      <button
        mat-raised-button
        color="primary"
        (click)="aceptar()"
        [disabled]="!editMode() || loading()"
        matTooltip="Guardar cambios"
      >
        <mat-icon>check</mat-icon>
        Aceptar
      </button>
      <button
        mat-raised-button
        (click)="cancelar()"
        [disabled]="!editMode() || loading()"
        matTooltip="Cancelar cambios"
      >
        <mat-icon>close</mat-icon>
        Cancelar
      </button>
    </div>

    <div class="table-scroll">
      <table mat-table [dataSource]="dataSource" class="mat-elevation-z0 cajas-table">
        <!-- Columna NOMBRE -->
        <ng-container matColumnDef="nombre">
          <th mat-header-cell *matHeaderCellDef>NOMBRE</th>
          <td mat-cell *matCellDef="let row" [class.editing]="isEditing(row)">
            @if (isEditing(row)) {
              <mat-form-field appearance="outline" class="inline-edit">
                <input
                  matInput
                  [(ngModel)]="row.nombre"
                  placeholder="Nombre de la caja física"
                  maxlength="100"
                  required
                />
              </mat-form-field>
            } @else {
              {{ row.nombre }}
            }
          </td>
        </ng-container>

        <!-- Columna CUENTA -->
        <ng-container matColumnDef="planCuenta">
          <th mat-header-cell *matHeaderCellDef>CUENTA</th>
          <td mat-cell *matCellDef="let row" [class.editing]="isEditing(row)">
            @if (isEditing(row)) {
              <mat-form-field appearance="outline" class="inline-edit">
                <mat-select
                  [(ngModel)]="row.planCuenta"
                  placeholder="Seleccione cuenta"
                  required
                  [compareWith]="comparePlanCuenta"
                >
                  <mat-option *ngFor="let plan of planesCuenta" [value]="plan">
                    {{ plan.cuentaContable }} - {{ plan.nombre }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            } @else {
              @if (row.planCuenta && row.planCuenta.codigo) {
                {{ row.planCuenta.cuentaContable }} - {{ row.planCuenta.nombre }}
              } @else {
                <span class="text-muted">Sin cuenta</span>
              }
            }
          </td>
        </ng-container>

        <!-- Columna F.INGRESO -->
        <ng-container matColumnDef="fechaIngreso">
          <th mat-header-cell *matHeaderCellDef>F.INGRESO</th>
          <td mat-cell *matCellDef="let row">{{ formatearFecha(row.fechaIngreso) }}</td>
        </ng-container>

        <!-- Columna F.ELIMINACION -->
        <ng-container matColumnDef="fechaInactivo">
          <th mat-header-cell *matHeaderCellDef>F.ELIMINACION</th>
          <td mat-cell *matCellDef="let row">{{ formatearFecha(row.fechaInactivo) }}</td>
        </ng-container>

        <!-- Columna ESTADO -->
        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef>ESTADO</th>
          <td mat-cell *matCellDef="let row">
            <span [class]="'estado-badge estado-' + row.estado">
              {{ getEstadoTexto(row.estado) }}
            </span>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns"
          [class.selected]="isSelected(row)"
          [class.editing-row]="isEditing(row)"
          (click)="seleccionarFila(row)"
        ></tr>
      </table>

      @if (dataSource.data.length === 0 && !loading()) {
        <div class="no-data">
          <mat-icon>info</mat-icon>
          <p>No hay cajas físicas registradas</p>
        </div>
      }
    </div>
  </div>
</div>
