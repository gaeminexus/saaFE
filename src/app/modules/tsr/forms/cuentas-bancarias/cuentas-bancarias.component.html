<div class="cuentas-admin">
  <div class="page-header">
    <div class="icon-wrap">
      <mat-icon>account_balance</mat-icon>
    </div>
    <div class="title-wrap">
      <h2 class="title">Cuentas Bancarias</h2>
      <p class="subtitle">Administración y consulta por Banco</p>
    </div>
    <div class="actions">
      <button mat-stroked-button color="primary" (click)="exportCuentasCSV()">
        <mat-icon>table_rows</mat-icon>
        CSV
      </button>
      <button mat-stroked-button color="primary" (click)="exportCuentasPDF()">
        <mat-icon>picture_as_pdf</mat-icon>
        PDF
      </button>
    </div>
  </div>

  <div class="listas">
    <section class="panel bancos">
      <header>
        <h3>Bancos</h3>
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Buscar</mat-label>
          <input matInput (input)="aplicarFiltroBancos($event.target.value)" />
        </mat-form-field>
      </header>

      <table mat-table [dataSource]="bancosPage()" class="mat-elevation-z1 bancos-table">
        <ng-container matColumnDef="nombre">
          <th mat-header-cell *matHeaderCellDef>DESCRIPCION</th>
          <td
            mat-cell
            *matCellDef="let row"
            (click)="seleccionarBanco(row)"
            [class.selected]="bancoSeleccionado()?.codigo === row.codigo"
          >
            {{ row.nombre }}
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="displayedColumnsBancos"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsBancos"></tr>
      </table>

      <mat-paginator
        [length]="bancosTotal()"
        [pageSize]="bancosPageSize()"
        [pageSizeOptions]="[5, 8, 10]"
        (page)="onBancosPageChange($event)"
      ></mat-paginator>
    </section>

    <section class="panel cuentas">
      <header>
        <h3>Cuentas Bancarias</h3>
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Buscar</mat-label>
          <input matInput (input)="aplicarFiltroCuentas($event.target.value)" />
        </mat-form-field>
      </header>

      <table mat-table [dataSource]="cuentasPage()" class="mat-elevation-z1 cuentas-table">
        <ng-container matColumnDef="numero">
          <th mat-header-cell *matHeaderCellDef>CUENTA</th>
          <td mat-cell *matCellDef="let row">{{ row.numeroCuenta }}</td>
        </ng-container>

        <ng-container matColumnDef="tipo">
          <th mat-header-cell *matHeaderCellDef>TIPO CUENTA</th>
          <td mat-cell *matCellDef="let row">{{ mostrarTipoCuenta(row) }}</td>
        </ng-container>

        <ng-container matColumnDef="saldo">
          <th mat-header-cell *matHeaderCellDef>SALDO INICIAL</th>
          <td mat-cell *matCellDef="let row">{{ row.saldoInicial | number: '1.2-2' }} $</td>
        </ng-container>

        <ng-container matColumnDef="cuentaContable">
          <th mat-header-cell *matHeaderCellDef>CUENTA CONTABLE</th>
          <td mat-cell *matCellDef="let row">{{ mostrarCuentaContable(row) }}</td>
        </ng-container>

        <ng-container matColumnDef="fIngreso">
          <th mat-header-cell *matHeaderCellDef>F. CREACIÓN</th>
          <td mat-cell *matCellDef="let row">{{ mostrarFechaIngreso(row) }}</td>
        </ng-container>

        <ng-container matColumnDef="fDesactiva">
          <th mat-header-cell *matHeaderCellDef>F. DESACTIV.</th>
          <td mat-cell *matCellDef="let row">{{ mostrarFechaInactivo(row) }}</td>
        </ng-container>

        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef>ESTADO</th>
          <td mat-cell *matCellDef="let row">{{ mostrarEstado(row) }}</td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef>ACCIONES</th>
          <td mat-cell *matCellDef="let row">
            <button mat-icon-button color="primary" (click)="editar(row)" matTooltip="Editar">
              <mat-icon>edit</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsCuentas"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsCuentas"></tr>
      </table>

      <mat-paginator
        [length]="cuentasTotal()"
        [pageSize]="cuentasPageSize()"
        [pageSizeOptions]="[5, 8, 10]"
        (page)="onCuentasPageChange($event)"
      ></mat-paginator>
    </section>
  </div>

  <section class="form-panel">
    <header>
      <h3>Información general de la cuenta bancaria</h3>
    </header>

    <div class="form-grid">
      <div class="row">
        <mat-form-field appearance="outline">
          <mat-label>Banco</mat-label>
          <input matInput [value]="bancoSeleccionado()?.nombre || ''" disabled />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Fecha de apertura</mat-label>
          <input matInput type="date" [(ngModel)]="fechaApertura" [disabled]="estaEditando()" />
        </mat-form-field>
      </div>

      <div class="row">
        <mat-form-field appearance="outline">
          <mat-label>Cuenta</mat-label>
          <input matInput [(ngModel)]="numeroCuenta" [disabled]="estaEditando()" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Titular</mat-label>
          <input matInput [(ngModel)]="titular" [disabled]="estaEditando()" />
        </mat-form-field>
      </div>

      <div class="row">
        <mat-form-field appearance="outline">
          <mat-label>Tipo Cuenta</mat-label>
          <mat-select
            [(ngModel)]="tipoCuentaSel"
            [compareWith]="compararRubros"
            [disabled]="estaEditando()"
          >
            <mat-option [value]="null">-- Sin especificar --</mat-option>
            <mat-option *ngFor="let r of tiposCuenta()" [value]="r">{{ r.descripcion }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Oficial de cuenta</mat-label>
          <input matInput [(ngModel)]="oficialCuenta" />
        </mat-form-field>
      </div>

      <div class="row">
        <mat-form-field appearance="outline">
          <mat-label>Saldo Inicial</mat-label>
          <input
            matInput
            type="text"
            [(ngModel)]="saldoInicial"
            placeholder="0.00"
            (blur)="formatearSaldo()"
            (focus)="$event.target.select()"
            [disabled]="estaEditando()"
          />
          <span matTextSuffix>$</span>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Cuenta Contable</mat-label>
          <mat-select [(ngModel)]="cuentaContableSeleccionada" [compareWith]="compararCuentas">
            <mat-option [value]="null">-- Sin especificar --</mat-option>
            <mat-option *ngFor="let c of cuentasContables()" [value]="c">
              {{ c.cuentaContable }} - {{ c.nombre }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="row">
        <mat-form-field appearance="outline" class="span-2">
          <mat-label>Observaciones</mat-label>
          <input matInput [(ngModel)]="observaciones" />
        </mat-form-field>
      </div>

      <div class="row">
        <mat-form-field appearance="outline">
          <mat-label>Estado</mat-label>
          <mat-select
            [(ngModel)]="estadoSeleccionado"
            [compareWith]="compararRubros"
            [disabled]="estaEditando()"
          >
            <mat-option [value]="null">-- Sin especificar --</mat-option>
            <mat-option *ngFor="let e of estadosCuenta()" [value]="e">
              {{ e.descripcion }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <div></div>
      </div>

      <div class="row row-4">
        <mat-form-field appearance="outline">
          <mat-label>Teléfono 1</mat-label>
          <input matInput [(ngModel)]="telefono1" [disabled]="estaEditando()" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Teléfono 2</mat-label>
          <input matInput [(ngModel)]="telefono2" [disabled]="estaEditando()" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Celular</mat-label>
          <input matInput [(ngModel)]="celular" [disabled]="estaEditando()" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Fax</mat-label>
          <input matInput [(ngModel)]="fax" [disabled]="estaEditando()" />
        </mat-form-field>
      </div>

      <div class="row">
        <mat-form-field appearance="outline" class="span-2">
          <mat-label>Dirección</mat-label>
          <input matInput [(ngModel)]="direccion" [disabled]="estaEditando()" />
        </mat-form-field>
      </div>

      <div class="row">
        <mat-form-field appearance="outline" class="span-2">
          <mat-label>E-mail</mat-label>
          <input matInput type="email" [(ngModel)]="email" [disabled]="estaEditando()" />
        </mat-form-field>
      </div>

      <div class="form-actions">
        <button
          mat-raised-button
          color="primary"
          (click)="estaEditando() ? actualizar() : guardar()"
          [disabled]="!formValido() || loading()"
        >
          <mat-icon>{{ estaEditando() ? 'edit' : 'save' }}</mat-icon>
          {{ estaEditando() ? 'Actualizar' : 'Guardar' }}
        </button>
        <button
          *ngIf="estaEditando()"
          mat-raised-button
          color="warn"
          (click)="cancelarEdicion()"
          [disabled]="loading()"
        >
          <mat-icon>cancel</mat-icon>
          Cancelar
        </button>
        <button
          *ngIf="!estaEditando()"
          mat-stroked-button
          color="accent"
          (click)="limpiarFormulario()"
          [disabled]="loading()"
        >
          <mat-icon>clear</mat-icon>
          Limpiar
        </button>
      </div>
    </div>

    <div class="error" *ngIf="errorMsg()">{{ errorMsg() }}</div>
  </section>
</div>
