<div class="carga-aportes-container">
  <!-- Header con título y filtros -->
  <div class="search-header">
    <div class="header-title">
      <mat-icon class="header-icon">cloud_upload</mat-icon>
      <h1>Carga de Archivos al Servidor</h1>
    </div>

    <div class="filters-box">
      <mat-form-field appearance="fill" class="filter-field">
        <mat-label>Filial</mat-label>
        <mat-select [(ngModel)]="filialSeleccionada" (selectionChange)="onFilialChange()" [disabled]="isLoadingFiliales()">
          <mat-option [value]="null">-- Seleccione una filial --</mat-option>
          @if (isLoadingFiliales()) {
            <mat-option disabled>
              <mat-spinner diameter="20"></mat-spinner>
              Cargando...
            </mat-option>
          } @else {
            @for (filial of filiales; track filial.codigo) {
              <mat-option [value]="filial.codigo">{{ filial.nombre }}</mat-option>
            }
          }
        </mat-select>
        <mat-icon matPrefix>business</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-field">
        <mat-label>Año</mat-label>
        <mat-select [(ngModel)]="anioSeleccionado" (ngModelChange)="onAnioChange()" [disabled]="anioDeshabilitado()">
          <mat-option [value]="null">-- Seleccione un año --</mat-option>
          @for (anio of anios; track anio) {
            <mat-option [value]="anio">{{ anio }}</mat-option>
          }
        </mat-select>
        <mat-icon matPrefix>calendar_today</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="fill" class="filter-field">
        <mat-label>Mes</mat-label>
        <mat-select [(ngModel)]="mesSeleccionado" [disabled]="mesDeshabilitado()">
          <mat-option [value]="null">-- Seleccione un mes --</mat-option>
          @for (mes of meses; track mes.valor) {
            <mat-option [value]="mes.valor" [disabled]="isMesDeshabilitado(mes.valor)" [ngClass]="{'mes-cargado': isMesDeshabilitado(mes.valor)}">
              {{ mes.nombre }}
              @if (isMesDeshabilitado(mes.valor)) {
                <span style="font-weight: 500;"> (Ya cargado)</span>
              }
            </mat-option>
          }
        </mat-select>
        <mat-icon matPrefix>event</mat-icon>
      </mat-form-field>

      @if (anioSeleccionado() || mesSeleccionado() || filialSeleccionada()) {
        <button mat-icon-button (click)="limpiarFiltros()" class="clear-button" matTooltip="Limpiar filtros">
          <mat-icon>clear</mat-icon>
        </button>
      }
    </div>
  </div>

  <!-- Área de contenido -->
  <div class="content-area">
    @if (cargaExitosa()) {
      <!-- Mensaje de éxito final -->
      <div class="success-state">
        <mat-icon class="success-icon">check_circle</mat-icon>
        <h2>¡Carga de Archivo Exitosa!</h2>
        <p>El archivo se procesó y almacenó correctamente en el servidor</p>
        <button mat-raised-button color="primary" (click)="limpiarFiltros()" class="new-load-button">
          <mat-icon>add</mat-icon>
          Nueva Carga
        </button>
      </div>
    } @else if (!anioSeleccionado() || !mesSeleccionado() || !filialSeleccionada()) {
      <div class="empty-state">
        <mat-icon class="empty-icon">filter_list</mat-icon>
        <h2>Seleccione los filtros</h2>
        <p>Seleccione año, mes y filial para continuar con la carga de archivos</p>
      </div>
    } @else {
      <!-- Sección combinada: Filtros y Carga de Archivo -->
      <div class="filters-upload-container">
        <div class="filters-summary">
          <mat-card class="summary-card">
            <mat-card-header>
              <mat-icon mat-card-avatar class="avatar-icon">info</mat-icon>
              <mat-card-title>Filtros Seleccionados</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="summary-items-row">
                <div class="summary-item">
                  <mat-icon>calendar_today</mat-icon>
                  <span class="label">Año:</span>
                  <span class="value">{{ anioSeleccionado() }}</span>
                </div>
                <div class="summary-item">
                  <mat-icon>event</mat-icon>
                  <span class="label">Mes:</span>
                  <span class="value">{{ meses[mesSeleccionado()! - 1].nombre }}</span>
                </div>
                <div class="summary-item">
                  <mat-icon>business</mat-icon>
                  <span class="label">Filial:</span>
                  <span class="value">{{ getFilialNombre(filialSeleccionada()) }}</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Área de carga de archivo con Drag & Drop -->
        @if (!isLoadingData()) {
          <div class="upload-area">
            <mat-card class="upload-card">
              <mat-card-header>
                <mat-icon mat-card-avatar class="avatar-icon">cloud_upload</mat-icon>
                <mat-card-title>Seleccionar Archivo</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <!-- Zona de Drag & Drop -->
                <div
                  class="drop-zone"
                  [class.dragging]="isDragging()"
                  (dragover)="onDragOver($event)"
                  (dragleave)="onDragLeave($event)"
                  (drop)="onDrop($event)">

                  @if (isDragging()) {
                    <div class="drop-content-row">
                      <mat-icon class="drop-icon">cloud_upload</mat-icon>
                      <p class="drop-text">Suelta el archivo aquí</p>
                    </div>
                  } @else {
                    <div class="drop-content-row">
                      <mat-icon class="drop-icon">cloud_upload</mat-icon>
                      <p class="drop-text">Arrastra el archivo aquí o</p>
                    </div>
                    <input
                      type="file"
                      #fileInput
                      accept=".txt"
                      (change)="onFileSelected($event)"
                      style="display: none;">

                    <button
                      mat-raised-button
                      color="primary"
                      class="upload-button"
                      (click)="fileInput.click()">
                      <mat-icon>upload_file</mat-icon>
                      <span>Seleccionar Archivo TXT</span>
                    </button>
                  }
                </div>

                @if (nombreArchivo) {
                  <div class="file-selected-wrapper">
                    <div class="file-selected-info">
                      @if (archivoValido) {
                        <mat-icon color="accent">check_circle</mat-icon>
                      } @else {
                        <mat-icon class="error-icon">error</mat-icon>
                      }
                      <span class="file-name">{{ nombreArchivo }}</span>

                      <button
                        mat-raised-button
                        color="accent"
                        class="validate-button"
                        [disabled]="isUploadingFile() || !archivoValido"
                        (click)="validarArchivo()">
                        @if (isUploadingFile()) {
                        <mat-spinner diameter="20"></mat-spinner>
                        <span>Validando...</span>
                      } @else {
                        <ng-container>
                          <mat-icon>verified</mat-icon>
                          <span>Validar Archivo</span>
                        </ng-container>
                      }
                    </button>
                    </div>

                    @if (mensajeErrorArchivo) {
                      <div class="file-error-message">
                        <mat-icon class="error-icon-small">warning</mat-icon>
                        <span class="error-text">{{ mensajeErrorArchivo }}</span>
                      </div>
                    }
                  </div>
                }
              </mat-card-content>
            </mat-card>
          </div>
        }
      </div>

      <!-- Loading de datos -->
      @if (isLoadingData()) {
        <div class="loading-state">
          <mat-spinner diameter="60"></mat-spinner>
          <h3>Procesando archivo...</h3>
          <p>Por favor espere mientras se valida el archivo</p>
        </div>
      }
    }
  </div>
</div>
