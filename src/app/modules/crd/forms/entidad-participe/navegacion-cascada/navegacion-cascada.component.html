<div class="navegacion-cascada">
  <!-- Header principal -->
  <div class="header">
    <h1>
      <mat-icon>account_tree</mat-icon>
      Navegaci√≥n en Cascada
    </h1>
    <p class="subtitle">Explora la informaci√≥n por niveles: Entidades ‚Üí Productos ‚Üí Pr√©stamos ‚Üí Pagos</p>
  </div>

  <!-- Breadcrumb navigation -->
  <div class="breadcrumb-container">
    <mat-chip-set class="breadcrumb-chips">
      <ng-container *ngFor="let crumb of breadcrumbs(); let i = index; let last = last">
        <mat-chip
          [class.active]="crumb.activo"
          [class.clickable]="!crumb.activo"
          (click)="!crumb.activo ? navegarA(crumb.nivel) : null"
          [matTooltip]="crumb.subtitulo || ''">

          <mat-icon [ngSwitch]="crumb.nivel">
            <ng-container *ngSwitchCase="1">business</ng-container>
            <ng-container *ngSwitchCase="2">inventory_2</ng-container>
            <ng-container *ngSwitchCase="3">account_balance</ng-container>
            <ng-container *ngSwitchCase="4">payment</ng-container>
          </mat-icon>

          {{ crumb.titulo }}

          <span class="breadcrumb-subtitle" *ngIf="crumb.subtitulo">
            {{ crumb.subtitulo }}
          </span>
        </mat-chip>
        <mat-icon class="breadcrumb-separator" *ngIf="!last">
          chevron_right
        </mat-icon>
      </ng-container>
    </mat-chip-set>
  </div>

  <!-- √Årea de contenido principal -->
  <mat-card class="content-card">

    <!-- Loading spinner -->
    <div class="loading-overlay" *ngIf="loading()">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Cargando datos...</p>
    </div>

    <!-- Error message -->
    <div class="error-message" *ngIf="errorMsg()">
      <mat-icon>error</mat-icon>
      {{ errorMsg() }}
    </div>

    <!-- NIVEL 1: ENTIDADES -->
    <div class="nivel-entidades" *ngIf="mostrandoEntidades && !loading()">
      <div class="nivel-header">
        <div class="titulo-seccion">
          <mat-icon>business</mat-icon>
          <h2>Entidades</h2>
          <span class="contador">({{ dataSourceEntidades.data.length }} registros)</span>
        </div>

        <!-- Filtro de b√∫squeda -->
        <mat-form-field appearance="outline" class="filtro-campo">
          <mat-label>Buscar entidades</mat-label>
          <mat-icon matPrefix>search</mat-icon>
          <input
            matInput
            (keyup)="aplicarFiltroEntidades($any($event.target).value)"
            placeholder="Buscar por raz√≥n social, identificaci√≥n..."
          />
        </mat-form-field>
      </div>

      <!-- Info de estado -->
      <div class="info-estado" style="padding: 12px; margin: 10px 0; border-radius: 4px; border-left: 4px solid #1976d2;"
           [ngStyle]="dataSourceEntidades.data.length > 0 ?
             {'background': '#e8f5e8', 'border-left-color': '#4caf50'} :
             {'background': '#fff3e0', 'border-left-color': '#ff9800'}">

        <div *ngIf="dataSourceEntidades.data.length > 0">
          <mat-icon style="vertical-align: middle; color: #4caf50; margin-right: 8px;">check_circle</mat-icon>
          <strong>{{ dataSourceEntidades.data.length }} entidades cargadas</strong>
          <div style="margin-top: 8px;">
            <small style="color: #666;">
              üìä Total: {{ totalEntidades() }} registros
              <span *ngIf="filtroEntidades"> | Filtrados: {{ totalEntidades() }}</span>
              <span *ngIf="totalEntidades() > pageSizeEnt"> | P√°ginas: {{ getTotalPages() }}</span>
            </small>
            <small *ngIf="dataSourceEntidades.data.length > 1000"
                   style="display: block; color: #4caf50; font-weight: 500;">
              ‚úÖ Paginaci√≥n activa - Navegue por p√°ginas o use filtros
            </small>
          </div>
        </div>

        <div *ngIf="dataSourceEntidades.data.length === 0">
          <mat-icon style="vertical-align: middle; color: #ff9800; margin-right: 8px;">warning</mat-icon>
          <strong>Sin datos disponibles</strong>
          <small style="display: block; margin-top: 4px; color: #666;">
            Verificar que el backend est√© ejecut√°ndose en puerto 8080
          </small>
        </div>
      </div>

      <!-- Tabla de entidades -->
      <div class="tabla-container">
        <table mat-table [dataSource]="dataSourceEntidades" [trackBy]="trackEntidad" matSort class="mat-elevation-z2">

          <!-- C√≥digo -->
          <ng-container matColumnDef="codigo">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>C√≥digo</th>
            <td mat-cell *matCellDef="let entidad">
              <span class="codigo-badge">{{ entidad.codigo }}</span>
            </td>
          </ng-container>

          <!-- Raz√≥n Social -->
          <ng-container matColumnDef="razonSocial">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Raz√≥n Social</th>
            <td mat-cell *matCellDef="let entidad">
              <div class="entidad-info">
                <span class="razon-social">{{ entidad.razonSocial || 'N/A' }}</span>
                <span class="nombre-comercial" *ngIf="entidad.nombreComercial">
                  {{ entidad.nombreComercial }}
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Identificaci√≥n -->
          <ng-container matColumnDef="numeroIdentificacion">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Identificaci√≥n</th>
            <td mat-cell *matCellDef="let entidad">
              <span class="identificacion">{{ entidad.numeroIdentificacion || 'N/A' }}</span>
            </td>
          </ng-container>

          <!-- Correo -->
          <ng-container matColumnDef="correoPersonal">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Correo</th>
            <td mat-cell *matCellDef="let entidad">
              <span class="correo">{{ entidad.correoPersonal || entidad.correoInstitucional || 'N/A' }}</span>
            </td>
          </ng-container>

          <!-- M√≥vil -->
          <ng-container matColumnDef="movil">
            <th mat-header-cell *matHeaderCellDef>M√≥vil</th>
            <td mat-cell *matCellDef="let entidad">
              <span class="telefono">{{ entidad.movil || entidad.telefono || 'N/A' }}</span>
            </td>
          </ng-container>

          <!-- Acciones -->
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let entidad">
              <button
                mat-raised-button
                color="primary"
                (click)="seleccionarEntidad(entidad)"
                matTooltip="Ver pr√©stamos de esta entidad">
                <mat-icon>arrow_forward</mat-icon>
                Ver Pr√©stamos
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="columnasEntidades"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: columnasEntidades;"
            class="fila-entidad"
            (click)="seleccionarEntidad(row)">
          </tr>
        </table>

        <!-- Paginador -->
        <mat-paginator
          *ngIf="totalEntidades() > 0"
          [length]="totalEntidades()"
          [pageSizeOptions]="[10, 20, 50, 100]"
          [pageSize]="pageSizeEnt"
          [pageIndex]="pageIndexEnt"
          (page)="pageChangedEntidades($event)"
          showFirstLastButtons
          class="paginator-entidades">
        </mat-paginator>

        <!-- Mensaje cuando no hay datos -->
        <div class="no-datos" *ngIf="dataSourceEntidades.data.length === 0 && !loading()">
          <mat-icon>business_center</mat-icon>
          <p>No se encontraron entidades</p>
        </div>
      </div>
    </div>

    <!-- NIVEL 2: PR√âSTAMOS -->
    <div class="nivel-prestamos-lista" *ngIf="mostrandoPrestamos && !loading()">
      <div class="nivel-header">
        <div class="titulo-seccion">
          <mat-icon>account_balance</mat-icon>
          <h2>Pr√©stamos</h2>
          <span class="contador">({{ dataSourceProductos.data.length }} registros)</span>
        </div>

        <!-- Filtro de b√∫squeda -->
        <mat-form-field appearance="outline" class="filtro-campo">
          <mat-label>Buscar pr√©stamos</mat-label>
          <mat-icon matPrefix>search</mat-icon>
          <input
            matInput
            (keyup)="currentFilterPrest = $any($event.target).value.trim().toLowerCase(); pageIndexPrest = 0; updatePagePrestamos()"
            placeholder="Buscar por c√≥digo, entidad, producto..."
          />
        </mat-form-field>
      </div>

      <!-- Informaci√≥n de la entidad seleccionada -->
      <div class="info-seleccion" *ngIf="entidadSeleccionada()">
        <mat-icon>info</mat-icon>
        <span>Pr√©stamos de: <strong>{{ entidadSeleccionada()!.razonSocial }}</strong></span>
      </div>

      <!-- Tabla de pr√©stamos -->
      <div class="tabla-container">
        <table mat-table [dataSource]="dataSourcePrestamos" matSort class="mat-elevation-z2">

          <!-- ID Asoprep -->
          <ng-container matColumnDef="codigo">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>ID Asoprep</th>
            <td mat-cell *matCellDef="let p">{{ p.idAsoprep }}</td>
          </ng-container>

          <!-- Producto -->
          <ng-container matColumnDef="producto">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Producto</th>
            <td mat-cell *matCellDef="let p">
              <div class="producto-info">
                <span class="nombre-producto">{{ getProductoNombre(p) }}</span>
                <small class="codigo-sbs" *ngIf="tieneCodigoSBS(p)">
                  SBS: {{ getProductoCodigoSBS(p) }}
                </small>
              </div>
            </td>
          </ng-container>

          <!-- Amortizaci√≥n -->
          <ng-container matColumnDef="amortizacion">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Amortizaci√≥n</th>
            <td mat-cell *matCellDef="let p">
              <mat-chip color="accent">{{ p.amortizacion || 'N/A' }}</mat-chip>
            </td>
          </ng-container>

          <!-- Monto Solicitado -->
          <ng-container matColumnDef="montoSolicitado">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Monto Solicitado</th>
            <td mat-cell *matCellDef="let p">{{ p.montoSolicitado | number:'1.2-2' }}</td>
          </ng-container>

          <!-- Estado -->
          <ng-container matColumnDef="estado">
            <th mat-header-cell *matHeaderCellDef>Estado</th>
            <td mat-cell *matCellDef="let p">
              <mat-chip>{{ getEstadoNombre(p) || 'N/A' }}</mat-chip>
            </td>
          </ng-container>

          <!-- Acciones -->
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let p">
              <button mat-raised-button color="primary" matTooltip="Ver detalle del pr√©stamo"
                      (click)="seleccionarPrestamo(p)">
                <mat-icon>arrow_forward</mat-icon>
                Ver Detalle
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="columnasPrestamosResumen"></tr>
          <tr mat-row *matRowDef="let row; columns: columnasPrestamosResumen;"></tr>
        </table>

        <!-- Paginador pr√©stamos -->
        <mat-paginator
          *ngIf="totalPrestamos() > 0"
          [length]="totalPrestamos()"
          [pageSizeOptions]="[10, 20, 50, 100]"
          [pageSize]="pageSizePrest"
          [pageIndex]="pageIndexPrest"
          (page)="pageChangedPrestamos($event)"
          showFirstLastButtons
          class="paginator-entidades">
        </mat-paginator>

        <!-- Mensaje cuando no hay datos -->
        <div class="no-datos" *ngIf="dataSourcePrestamos.data.length === 0 && !loading()">
          <mat-icon>account_balance</mat-icon>
          <p>No se encontraron pr√©stamos para esta entidad</p>
        </div>
      </div>
    </div>

    <!-- NIVEL 3: DETALLE PR√âSTAMOS -->
    <div class="nivel-detalle-prestamos" *ngIf="mostrandoDetallePrestamos && !loading()">
      <div class="nivel-header">
        <div class="titulo-seccion">
          <mat-icon>receipt</mat-icon>
          <h2>Cuotas del Pr√©stamo</h2>
          <span class="contador">({{ totalDetallePrestamos() }} cuotas)</span>
        </div>

        <!-- Filtro de b√∫squeda -->
        <mat-form-field appearance="outline" class="filtro-campo">
          <mat-label>Buscar en detalle</mat-label>
          <mat-icon matPrefix>search</mat-icon>
          <input
            matInput
            (keyup)="currentFilterPrest = $any($event.target).value.trim().toLowerCase(); pageIndexPrest = 0; updatePagePrestamos()"
            placeholder="Buscar por cuota, fecha, capital..."
          />
        </mat-form-field>
      </div>

      <div class="info-seleccion" *ngIf="prestamoSeleccionado()">
        <mat-icon>info</mat-icon>
        <span>Detalle del pr√©stamo: <strong>ID Asoprep {{ prestamoSeleccionado()!.idAsoprep }}</strong> -
          {{ getProductoNombre(prestamoSeleccionado()!) }}
        </span>
      </div>

      <div class="tabla-container">
        <table mat-table [dataSource]="dataSourceDetallePrestamos" matSort class="mat-elevation-z2">

          <!-- N√∫mero de Cuota -->
          <ng-container matColumnDef="numeroCuota">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Cuota #</th>
            <td mat-cell *matCellDef="let d">{{ d.numeroCuota }}</td>
          </ng-container>

          <!-- Fecha Vencimiento -->
          <ng-container matColumnDef="fechaVencimiento">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Vencimiento</th>
            <td mat-cell *matCellDef="let d">{{ getFechaFormateada(d.fechaVencimiento) || 'Sin fecha' }}</td>
          </ng-container>

          <!-- Capital -->
          <ng-container matColumnDef="capital">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Capital</th>
            <td mat-cell *matCellDef="let d">{{ formatearMoneda(d.capital) }}</td>
          </ng-container>

          <!-- Inter√©s -->
          <ng-container matColumnDef="interes">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Inter√©s</th>
            <td mat-cell *matCellDef="let d">{{ formatearMoneda(d.interes) }}</td>
          </ng-container>

          <!-- Mora -->
          <ng-container matColumnDef="mora">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Mora</th>
            <td mat-cell *matCellDef="let d">{{ formatearMoneda(d.mora) }}</td>
          </ng-container>

          <!-- Inter√©s Vencido -->
          <ng-container matColumnDef="interesVencido">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Int. Vencido</th>
            <td mat-cell *matCellDef="let d">{{ formatearMoneda(d.interesVencido) }}</td>
          </ng-container>

          <!-- Saldo Capital -->
          <ng-container matColumnDef="saldoCapital">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Saldo Capital</th>
            <td mat-cell *matCellDef="let d">{{ formatearDecimal(d.saldoCapital) }}</td>
          </ng-container>

          <!-- Fecha Pagado -->
          <ng-container matColumnDef="fechaPagado">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha Pagado</th>
            <td mat-cell *matCellDef="let d">
              <mat-chip [color]="tieneFechaValida(d.fechaPagado) ? 'primary' : 'warn'">
                {{ tieneFechaValida(d.fechaPagado) ? getFechaFormateada(d.fechaPagado) : 'Pendiente' }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Acciones -->
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let d">
              <button mat-raised-button
                      color="primary"
                      (click)="seleccionarDetallePrestamo(d); $event.stopPropagation()"
                      class="action-button">
                <mat-icon>payment</mat-icon>
                Ver Pagos
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="columnasDetallePrestamos"></tr>
          <tr mat-row *matRowDef="let row; columns: columnasDetallePrestamos;"></tr>
        </table>

        <!-- Paginador detalle pr√©stamos -->
        <mat-paginator
          *ngIf="totalDetallePrestamos() > 0"
          [length]="totalDetallePrestamos()"
          [pageSizeOptions]="[10, 20, 50, 100]"
          [pageSize]="pageSizeDet"
          [pageIndex]="pageIndexDet"
          (page)="pageChangedDetallePrestamos($event)"
          showFirstLastButtons
          class="paginator-entidades">
        </mat-paginator>

        <div class="no-datos" *ngIf="dataSourceDetallePrestamos.data.length === 0 && !loading()">
          <mat-icon>receipt</mat-icon>
          <p>No se encontraron cuotas para este pr√©stamo</p>
        </div>
      </div>
    </div>

  </mat-card>
</div>

<!-- NIVEL 4: PAGOS DEL DETALLE PR√âSTAMO -->
<div *ngIf="detallePrestamoSeleccionado()" class="navigation-level nivel-pagos">
  <mat-card class="data-card">
    <mat-card-header class="card-header">
      <div class="header-content">
        <mat-card-title class="card-title">
          <mat-icon class="title-icon">payment</mat-icon>
          Pagos de la Cuota {{ detallePrestamoSeleccionado()?.numeroCuota }}
        </mat-card-title>
        <mat-card-subtitle class="card-subtitle">
          Detalle de pagos realizados para esta cuota
        </mat-card-subtitle>
      </div>

      <div class="header-actions">
        <mat-chip-set>
          <mat-chip color="accent">
            <mat-icon>receipt_long</mat-icon>
            Total: {{ totalPagos() }}
          </mat-chip>
        </mat-chip-set>
      </div>
    </mat-card-header>

    <mat-card-content class="card-content">
      <div class="table-container">
        <table mat-table [dataSource]="dataSourcePagos" matSort class="full-width-table">

          <!-- Fecha -->
          <ng-container matColumnDef="fecha">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha Pago</th>
            <td mat-cell *matCellDef="let p">
              <mat-chip color="primary">
                {{ getFechaFormateada(p.fecha) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Valor -->
          <ng-container matColumnDef="valor">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Valor</th>
            <td mat-cell *matCellDef="let p" class="text-right">
              <strong>{{ formatearMoneda(p.valor) }}</strong>
            </td>
          </ng-container>

          <!-- N√∫mero Cuota -->
          <ng-container matColumnDef="numeroCuota">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>N¬∞ Cuota</th>
            <td mat-cell *matCellDef="let p">
              <mat-chip>{{ p.numeroCuota }}</mat-chip>
            </td>
          </ng-container>

          <!-- Capital Pagado -->
          <ng-container matColumnDef="capitalPagado">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Capital</th>
            <td mat-cell *matCellDef="let p" class="text-right">
              {{ formatearDecimal(p.capitalPagado) }}
            </td>
          </ng-container>

          <!-- Inter√©s Pagado -->
          <ng-container matColumnDef="interesPagado">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Inter√©s</th>
            <td mat-cell *matCellDef="let p" class="text-right">
              {{ formatearDecimal(p.interesPagado) }}
            </td>
          </ng-container>

          <!-- Mora Pagada -->
          <ng-container matColumnDef="moraPagada">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Mora</th>
            <td mat-cell *matCellDef="let p" class="text-right">
              {{ formatearDecimal(p.moraPagada) }}
            </td>
          </ng-container>

          <!-- ID Estado -->
          <ng-container matColumnDef="idEstado">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
            <td mat-cell *matCellDef="let p">
              <mat-chip [color]="p.idEstado === 1 ? 'primary' : 'warn'">
                {{ p.idEstado === 1 ? 'Activo' : 'Inactivo' }}
              </mat-chip>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="columnasPagos"></tr>
          <tr mat-row *matRowDef="let row; columns: columnasPagos;"></tr>
        </table>

        <!-- Paginador pagos -->
        <mat-paginator
          *ngIf="totalPagos() > 0"
          [length]="totalPagos()"
          [pageSizeOptions]="[10, 20, 50, 100]"
          [pageSize]="pageSizePag"
          [pageIndex]="pageIndexPag"
          (page)="pageChangedPagos($event)"
          showFirstLastButtons
          class="paginator-entidades">
        </mat-paginator>

        <div class="no-datos" *ngIf="dataSourcePagos.data.length === 0 && !loading()">
          <mat-icon>payment</mat-icon>
          <p>No se encontraron pagos para esta cuota</p>
        </div>
      </div>
    </mat-card-content>

  </mat-card>
</div>
