<div class="edit-container">
  <div class="header-section">
    <button mat-icon-button (click)="volver()" class="back-btn" matTooltip="Volver">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>
      <mat-icon>{{ editMode() ? 'edit' : 'note_add' }}</mat-icon>
      {{ editMode() ? 'Editar Contrato' : 'Nuevo Contrato' }}
    </h1>
  </div>

  @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="60"></mat-spinner>
      <p>{{ editMode() ? 'Cargando contrato...' : 'Guardando...' }}</p>
    </div>
  }

  @if (!loading()) {
    <form [formGroup]="form" class="form-container">
      <!-- Sección Básica -->
      <mat-card class="form-section">
        <mat-card-header>
          <mat-icon mat-card-avatar>info</mat-icon>
          <mat-card-title>Información Básica</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="form-grid">
            @if (editMode()) {
              <mat-form-field appearance="outline">
                <mat-label>Código</mat-label>
                <input matInput formControlName="codigo" readonly>
              </mat-form-field>
            }

            <mat-form-field appearance="outline">
              <mat-label>Código Entidad</mat-label>
              <input matInput type="number" formControlName="codigoEntidad" required>
              @if (form.get('codigoEntidad')?.hasError('required') && form.get('codigoEntidad')?.touched) {
                <mat-error>Campo requerido</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Fecha Inicio</mat-label>
              <input matInput [matDatepicker]="pickerInicio" formControlName="fechaInicio" required>
              <mat-datepicker-toggle matIconSuffix [for]="pickerInicio"></mat-datepicker-toggle>
              <mat-datepicker #pickerInicio></mat-datepicker>
              @if (form.get('fechaInicio')?.hasError('required') && form.get('fechaInicio')?.touched) {
                <mat-error>Campo requerido</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Fecha Fin</mat-label>
              <input matInput [matDatepicker]="pickerFin" formControlName="fechaFin">
              <mat-datepicker-toggle matIconSuffix [for]="pickerFin"></mat-datepicker-toggle>
              <mat-datepicker #pickerFin></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Filial</mat-label>
              <input matInput formControlName="filial">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Estado</mat-label>
              <input matInput formControlName="estado">
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Sección Aportes -->
      <mat-card class="form-section">
        <mat-card-header>
          <mat-icon mat-card-avatar>account_balance_wallet</mat-icon>
          <mat-card-title>Configuración de Aportes</mat-card-title>
          <mat-card-subtitle>Al menos un porcentaje debe ser mayor a 0</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>% Aporte Individual</mat-label>
              <input matInput type="number" formControlName="porcentajeAporteIndividual" min="0" max="100">
              @if (form.get('porcentajeAporteIndividual')?.hasError('min')) {
                <mat-error>Mínimo 0%</mat-error>
              }
              @if (form.get('porcentajeAporteIndividual')?.hasError('max')) {
                <mat-error>Máximo 100%</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>% Aporte Jubilación</mat-label>
              <input matInput type="number" formControlName="porcentajeAporteJubilacion" min="0" max="100">
              @if (form.get('porcentajeAporteJubilacion')?.hasError('min')) {
                <mat-error>Mínimo 0%</mat-error>
              }
              @if (form.get('porcentajeAporteJubilacion')?.hasError('max')) {
                <mat-error>Máximo 100%</mat-error>
              }
            </mat-form-field>
          </div>

          @if (form.hasError('alMenosUnAporte') && form.touched) {
            <div class="validation-error">
              <mat-icon>warning</mat-icon>
              <span>Debe especificar al menos un porcentaje de aporte mayor a 0</span>
            </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Sección Observaciones -->
      <mat-card class="form-section">
        <mat-card-header>
          <mat-icon mat-card-avatar>notes</mat-icon>
          <mat-card-title>Observaciones</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Observación</mat-label>
            <textarea matInput formControlName="observacion" rows="4"></textarea>
          </mat-form-field>
        </mat-card-content>
      </mat-card>

      <!-- Acciones -->
      <div class="form-actions">
        <button mat-stroked-button type="button" (click)="volver()">
          <mat-icon>cancel</mat-icon>
          Cancelar
        </button>
        <button mat-raised-button color="primary" type="button" (click)="guardar()" [disabled]="form.invalid || loading()">
          <mat-icon>save</mat-icon>
          {{ editMode() ? 'Actualizar' : 'Guardar' }}
        </button>
      </div>
    </form>
  }
</div>
