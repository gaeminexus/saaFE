<div class="pago-cuotas-container">
  <!-- Header con búsqueda -->
  @if (mostrarBusqueda) {
  <div class="search-header">
    <div class="header-title">
      <mat-icon class="header-icon">payment</mat-icon>
      <h1>Pago de Cuotas</h1>
    </div>

    <div class="search-box">
      <mat-form-field appearance="fill" class="search-field">
        <mat-label>Buscar por Cédula, Razón Social o Nombre Comercial</mat-label>
        <input
          matInput
          [(ngModel)]="searchText"
          (keyup.enter)="buscarEntidad()"
          placeholder="Ej: 1234567890, EMPRESA S.A., Mi Negocio"
        />
        <mat-icon matPrefix>search</mat-icon>
        @if (searchText) {
        <button matSuffix mat-icon-button (click)="limpiarBusqueda()">
          <mat-icon>clear</mat-icon>
        </button>
        }
      </mat-form-field>
      <button
        mat-raised-button
        color="primary"
        (click)="buscarEntidad()"
        [disabled]="isSearching"
        class="search-button"
      >
        @if (isSearching) {
        <mat-spinner diameter="20"></mat-spinner>
        } @else {
        <ng-container>
          <mat-icon>search</mat-icon>
          Buscar
        </ng-container>
        }
      </button>
    </div>
  </div>
  }

  <!-- Spinner de carga -->
  @if (isLoadingBusqueda || isLoadingDatos) {
  <div class="loading-spinner-container">
    <mat-spinner diameter="60" color="primary"></mat-spinner>
    <p class="loading-text">Cargando información...</p>
  </div>
  }

  <!-- Contenido principal -->
  @if (!isLoadingBusqueda && !isLoadingDatos && entidadEncontrada) {
  <div class="pago-content">
    <!-- Tarjeta de información de entidad -->
    <mat-card class="entidad-card">
      <mat-card-header>
        <mat-icon mat-card-avatar class="avatar-icon">business</mat-icon>
        <div class="header-content">
          <mat-card-title>
            {{ entidadEncontrada.razonSocial || entidadEncontrada.nombreComercial }}
          </mat-card-title>
          <mat-card-subtitle>
            <span class="info-item">
              <mat-icon>badge</mat-icon>
              <strong>{{ entidadEncontrada.numeroIdentificacion }}</strong>
            </span>
            @if (entidadEncontrada.nombreComercial && entidadEncontrada.razonSocial !==
            entidadEncontrada.nombreComercial) {
            <span class="info-item">
              <mat-icon>store</mat-icon>
              {{ entidadEncontrada.nombreComercial }}
            </span>
            }
          </mat-card-subtitle>
        </div>
      </mat-card-header>

      <!-- Información del Partícipe -->
      @if (participeEncontrado) {
      <mat-card-content>
        <h3 class="section-title">Información del Partícipe</h3>
        <div class="participe-info-grid">
          <div class="participe-item">
            <mat-icon>work</mat-icon>
            <div class="item-content">
              <span class="item-label">Cargo Actual</span>
              <span class="item-value">{{ participeEncontrado.cargoActual || 'N/A' }}</span>
            </div>
          </div>

          <div class="participe-item">
            <mat-icon>calendar_today</mat-icon>
            <div class="item-content">
              <span class="item-label">Fecha de Ingreso al Fondo</span>
              <span class="item-value">
                {{
                  participeEncontrado.fechaIngresoFondo
                    ? (participeEncontrado.fechaIngresoFondo | date : 'dd/MM/yyyy')
                    : 'N/A'
                }}
              </span>
            </div>
          </div>

          <div class="participe-item">
            <mat-icon>business_center</mat-icon>
            <div class="item-content">
              <span class="item-label">Unidad Administrativa</span>
              <span class="item-value">{{
                participeEncontrado.unidadAdministrativa || 'N/A'
              }}</span>
            </div>
          </div>

          <div class="participe-item">
            <mat-icon>location_on</mat-icon>
            <div class="item-content">
              <span class="item-label">Lugar de Trabajo</span>
              <span class="item-value">{{ participeEncontrado.lugarTrabajo || 'N/A' }}</span>
            </div>
          </div>
        </div>
      </mat-card-content>
      }
    </mat-card>

    <!-- Botones de acción -->
    <div class="action-buttons">
      <button
        mat-raised-button
        color="primary"
        (click)="exportarCSV()"
        [disabled]="prestamos.length === 0"
        matTooltip="Descargar datos en formato CSV"
      >
        <mat-icon>download</mat-icon>
        <span>Descargar CSV</span>
      </button>
      <button
        mat-raised-button
        color="accent"
        (click)="exportarPDF()"
        [disabled]="prestamos.length === 0"
        matTooltip="Descargar datos en formato PDF"
      >
        <mat-icon>picture_as_pdf</mat-icon>
        <span>Descargar PDF</span>
      </button>
      <button
        mat-raised-button
        (click)="regresarAPantallaAnterior()"
        matTooltip="Volver al menú anterior"
      >
        <mat-icon>arrow_back</mat-icon>
        <span>Regresar</span>
      </button>
    </div>

    <!-- Tarjeta de Resumen de Préstamos -->
    @if (prestamos && prestamos.length > 0) {
    <mat-card class="resumen-card">
      <mat-card-header>
        <div class="card-header-content">
          <mat-icon>summarize</mat-icon>
          <mat-card-title>Resumen de Préstamos</mat-card-title>
        </div>
        <div class="card-header-actions">
          <button
            mat-icon-button
            color="warn"
            (click)="generarPDFResumen()"
            matTooltip="Generar PDF Resumen"
            class="pdf-button"
          >
            <mat-icon>picture_as_pdf</mat-icon>
          </button>
        </div>
      </mat-card-header>

      <mat-card-content>
        <div class="resumen-grid">
          <div class="resumen-item">
            <mat-icon class="resumen-icon">account_balance_wallet</mat-icon>
            <div class="resumen-content">
              <span class="resumen-label">Total Préstamos</span>
              <span class="resumen-value">{{ prestamos.length }}</span>
            </div>
          </div>

          <div class="resumen-item">
            <mat-icon class="resumen-icon">attach_money</mat-icon>
            <div class="resumen-content">
              <span class="resumen-label">Monto Total Solicitado</span>
              <span class="resumen-value highlight">{{
                calcularTotalSolicitado() | currency
              }}</span>
            </div>
          </div>

          <div class="resumen-item">
            <mat-icon class="resumen-icon success">payments</mat-icon>
            <div class="resumen-content">
              <span class="resumen-label">Total Pagado</span>
              <span class="resumen-value success">{{ calcularTotalPagado() | currency }}</span>
            </div>
          </div>

          <div class="resumen-item">
            <mat-icon class="resumen-icon warning">account_balance</mat-icon>
            <div class="resumen-content">
              <span class="resumen-label">Saldo Pendiente</span>
              <span class="resumen-value warning">{{ calcularSaldoPendiente() | currency }}</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
    }

    <!-- Tabla de préstamos -->
    <mat-card class="datos-card">
      <mat-card-header>
        <div class="card-header-content">
          <mat-icon>credit_card</mat-icon>
          <mat-card-title>Préstamos Vigentes</mat-card-title>
        </div>
      </mat-card-header>

      <mat-card-content>
        @if (prestamos && prestamos.length > 0) {

        <!-- Tabla de préstamos -->
        <div class="table-wrapper">
          <div class="table-container">
            <table mat-table [dataSource]="prestamos" class="prestamos-table">
              <!-- Columna ID Asoprep -->
              <ng-container matColumnDef="codigo">
                <th mat-header-cell *matHeaderCellDef class="col-numero">ID Asoprep</th>
                <td mat-cell *matCellDef="let prestamo" class="col-numero">
                  <span class="codigo-badge">
                    {{ prestamo.idAsoprep }}
                  </span>
                </td>
              </ng-container>

              <!-- Columna Producto -->
              <ng-container matColumnDef="producto">
                <th mat-header-cell *matHeaderCellDef class="col-tipo">Producto</th>
                <td mat-cell *matCellDef="let prestamo" class="col-tipo">
                  <div class="tipo-cell">
                    <mat-icon>account_balance</mat-icon>
                    <span>{{ prestamo.producto?.nombre || 'Sin Producto' }}</span>
                  </div>
                </td>
              </ng-container>

              <!-- Columna Fecha -->
              <ng-container matColumnDef="fecha">
                <th mat-header-cell *matHeaderCellDef class="col-fecha">Fecha</th>
                <td mat-cell *matCellDef="let prestamo" class="col-fecha">
                  {{ prestamo.fecha | date : 'dd/MM/yyyy' }}
                </td>
              </ng-container>

              <!-- Columna Monto Solicitado -->
              <ng-container matColumnDef="montoSolicitado">
                <th mat-header-cell *matHeaderCellDef class="col-numero">Monto Solicitado</th>
                <td mat-cell *matCellDef="let prestamo" class="col-numero">
                  <span class="currency-value">
                    {{ prestamo.montoSolicitado | currency }}
                  </span>
                </td>
              </ng-container>

              <!-- Columna Total Pagado -->
              <ng-container matColumnDef="totalPagado">
                <th mat-header-cell *matHeaderCellDef class="col-numero">Total Pagado</th>
                <td mat-cell *matCellDef="let prestamo" class="col-numero">
                  <span class="currency-value pagado">
                    {{ prestamo.totalPagado | currency }}
                  </span>
                </td>
              </ng-container>

              <!-- Columna Saldo Total -->
              <ng-container matColumnDef="saldoTotal">
                <th mat-header-cell *matHeaderCellDef class="col-numero">Saldo Total</th>
                <td mat-cell *matCellDef="let prestamo" class="col-numero">
                  <span
                    class="currency-value saldo-value"
                    [class.saldo-positivo]="prestamo.saldoTotal > 0"
                    [class.saldo-cero]="prestamo.saldoTotal === 0"
                  >
                    {{ prestamo.saldoTotal | currency }}
                  </span>
                </td>
              </ng-container>

              <!-- Columna Estado -->
              <ng-container matColumnDef="estado">
                <th mat-header-cell *matHeaderCellDef class="col-estado">Estado</th>
                <td mat-cell *matCellDef="let prestamo" class="col-estado">
                  <span class="estado-badge">
                    {{ prestamo.estadoPrestamo?.nombre || 'Sin Estado' }}
                  </span>
                </td>
              </ng-container>

              <!-- Columna Acciones -->
              <ng-container matColumnDef="acciones">
                <th mat-header-cell *matHeaderCellDef class="col-acciones">Acciones</th>
                <td mat-cell *matCellDef="let prestamo" class="col-acciones">
                  <button
                    mat-icon-button
                    color="primary"
                    matTooltip="Ver detalle del préstamo"
                    (click)="verDetallePrestamo(prestamo)"
                  >
                    <mat-icon>visibility</mat-icon>
                  </button>
                  <button
                    mat-raised-button
                    color="accent"
                    class="btn-pago-cuota"
                    matTooltip="Pagar cuota"
                    [disabled]="prestamo.saldoTotal <= 0"
                    (click)="realizarPagoCuota(prestamo)"
                  >
                    <mat-icon>payment</mat-icon>
                    <span>Pagar Cuota</span>
                  </button>
                </td>
              </ng-container>

              <tr
                mat-header-row
                *matHeaderRowDef="[
                  'codigo',
                  'producto',
                  'fecha',
                  'montoSolicitado',
                  'totalPagado',
                  'saldoTotal',
                  'estado',
                  'acciones'
                ]"
              ></tr>
              <tr
                mat-row
                *matRowDef="
                  let row;
                  columns: [
                    'codigo',
                    'producto',
                    'fecha',
                    'montoSolicitado',
                    'totalPagado',
                    'saldoTotal',
                    'estado',
                    'acciones'
                  ]
                "
                class="table-row"
              ></tr>
            </table>
          </div>
        </div>
        } @else {
        <div class="no-data">
          <mat-icon>info</mat-icon>
          <p>No hay préstamos disponibles para esta entidad</p>
        </div>
        }
      </mat-card-content>
    </mat-card>
  </div>
  }

  <!-- Mensaje inicial -->
  @if (!entidadEncontrada && !isLoadingBusqueda) {
  <div class="initial-message">
    <mat-icon class="message-icon">info</mat-icon>
    <p>Ingrese los datos de búsqueda para consultar los préstamos</p>
  </div>
  }
</div>
