<div class="container-mayorizacion">
  <mat-card class="proceso-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>account_balance</mat-icon>
        Proceso de Mayorización
      </mat-card-title>
      <mat-card-subtitle>
        Ejecuta el proceso de mayorización de asientos contables al libro mayor
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <mat-tab-group>
        <!-- Tab Proceso -->
        <mat-tab label="Ejecutar Proceso">
          <div class="tab-content">
            <form [formGroup]="formProceso" class="proceso-form">
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Empresa</mat-label>
                  <mat-select [formControl]="$any(formProceso.get('empresa'))" required>
                    <mat-option [value]="1">Empresa Principal</mat-option>
                  </mat-select>
                  <mat-error *ngIf="$any(formProceso.get('empresa'))?.hasError('required')">
                    La empresa es requerida
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Tipo de Proceso</mat-label>
                  <mat-select [formControl]="$any(formProceso.get('proceso'))" required>
                    <mat-option *ngFor="let tipo of tiposProceso" [value]="tipo.value">
                      {{ tipo.label }}
                    </mat-option>
                  </mat-select>
                  <mat-error *ngIf="$any(formProceso.get('proceso'))?.hasError('required')">
                    El tipo de proceso es requerido
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Período Desde</mat-label>
                  <mat-select [formControl]="$any(formProceso.get('periodoDesde'))" required>
                    <mat-option *ngFor="let periodo of periodos" [value]="periodo.codigo">
                      {{ periodo.nombre }} ({{ periodo.anio }})
                    </mat-option>
                  </mat-select>
                  <mat-error *ngIf="$any(formProceso.get('periodoDesde'))?.hasError('required')">
                    El período desde es requerido
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Período Hasta</mat-label>
                  <mat-select [formControl]="$any(formProceso.get('periodoHasta'))" required>
                    <mat-option *ngFor="let periodo of periodos" [value]="periodo.codigo">
                      {{ periodo.nombre }} ({{ periodo.anio }})
                    </mat-option>
                  </mat-select>
                  <mat-error *ngIf="$any(formProceso.get('periodoHasta'))?.hasError('required')">
                    El período hasta es requerido
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="action-buttons">
                <button
                  mat-raised-button
                  color="primary"
                  type="button"
                  [disabled]="!formProceso.valid || procesando"
                  (click)="ejecutarProceso()">
                  <mat-icon *ngIf="!procesando">play_arrow</mat-icon>
                  <mat-progress-spinner
                    *ngIf="procesando"
                    diameter="20"
                    mode="indeterminate">
                  </mat-progress-spinner>
                  {{ procesando ? 'Procesando...' : 'Ejecutar Mayorización' }}
                </button>

                <button
                  mat-raised-button
                  color="warn"
                  type="button"
                  [disabled]="!formProceso.valid || procesando"
                  (click)="ejecutarDesmayorizacion()">
                  <mat-icon *ngIf="!procesando">undo</mat-icon>
                  <mat-progress-spinner
                    *ngIf="procesando"
                    diameter="20"
                    mode="indeterminate">
                  </mat-progress-spinner>
                  {{ procesando ? 'Procesando...' : 'Ejecutar Desmayorización' }}
                </button>

                <button
                  mat-button
                  type="button"
                  [disabled]="procesando"
                  (click)="cargarMayorizaciones()">
                  <mat-icon>refresh</mat-icon>
                  Actualizar
                </button>
              </div>
            </form>
          </div>
        </mat-tab>

        <!-- Tab Historial -->
        <mat-tab label="Historial de Mayorizaciones">
          <div class="tab-content">
            <div class="table-container" *ngIf="mayorizaciones.length > 0; else noMayorizaciones">
              <mat-table [dataSource]="mayorizaciones" class="mayorizaciones-table">

                <ng-container matColumnDef="codigo">
                  <mat-header-cell *matHeaderCellDef>Código</mat-header-cell>
                  <mat-cell *matCellDef="let element">{{ element.codigo }}</mat-cell>
                </ng-container>

                <ng-container matColumnDef="periodo">
                  <mat-header-cell *matHeaderCellDef>Período</mat-header-cell>
                  <mat-cell *matCellDef="let element">
                    {{ element.periodo?.nombre }} ({{ element.periodo?.anio }})
                  </mat-cell>
                </ng-container>

                <ng-container matColumnDef="fecha">
                  <mat-header-cell *matHeaderCellDef>Fecha</mat-header-cell>
                  <mat-cell *matCellDef="let element">
                    {{ element.fecha | date:'dd/MM/yyyy HH:mm' }}
                  </mat-cell>
                </ng-container>

                <ng-container matColumnDef="acciones">
                  <mat-header-cell *matHeaderCellDef>Acciones</mat-header-cell>
                  <mat-cell *matCellDef="let element">
                    <button mat-icon-button color="primary"
                      [disabled]="procesando"
                      matTooltip="Ver detalle">
                      <mat-icon>visibility</mat-icon>
                    </button>
                  </mat-cell>
                </ng-container>

                <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
                <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
              </mat-table>
            </div>

            <ng-template #noMayorizaciones>
              <div class="no-data">
                <mat-icon class="no-data-icon">account_balance</mat-icon>
                <h3>No hay mayorizaciones registradas</h3>
                <p>Las mayorizaciones aparecerán aquí después de ejecutar el proceso.</p>
                <button mat-button color="primary" (click)="cargarMayorizaciones()">
                  <mat-icon>refresh</mat-icon>
                  Actualizar
                </button>
              </div>
            </ng-template>
          </div>
        </mat-tab>
      </mat-tab-group>
    </mat-card-content>
  </mat-card>

  <!-- Información adicional -->
  <mat-card class="info-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>info</mat-icon>
        Información del Proceso
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="info-content">
        <h4>¿Qué hace la mayorización?</h4>
        <p>
          El proceso de mayorización transfiere los movimientos de los asientos contables
          al libro mayor, calculando los saldos de cada cuenta para el período seleccionado.
        </p>

        <h4>Tipos de mayorización:</h4>
        <ul>
          <li><strong>Normal:</strong> Procesa los asientos del período regular</li>
          <li><strong>De cierre:</strong> Procesa los asientos de cierre del ejercicio</li>
        </ul>

        <h4>Desmayorización:</h4>
        <p>
          Revierte el proceso de mayorización, eliminando los movimientos del libro mayor
          para permitir modificaciones en los asientos contables.
        </p>
      </div>
    </mat-card-content>
  </mat-card>
</div>
