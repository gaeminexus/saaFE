<div class="form-container">
  <!-- Header del diálogo -->
  <div class="form-header">
    <div class="title-section">
      <h2>{{ dialogTitle }}</h2>
      @if (parentAccount && !isEdit) {
      <div class="parent-info">
        <mat-icon class="info-icon">account_tree</mat-icon>
        <span>Subcentro de: {{ parentAccount.nombre }} (N° {{ parentAccount.numero }})</span>
      </div>
      }
    </div>
    <button mat-icon-button (click)="onCancel()" class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Formulario -->
  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="form-body">
    <!-- Error general -->
    @if (error) {
    <div class="error-banner">
      <mat-icon class="banner-icon">error</mat-icon>
      <span>{{ error }}</span>
    </div>
    }

    <!-- Grid de campos -->
    <div class="form-grid">
      <!-- Nombre del centro -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Nombre del centro de costo</mat-label>
        <input
          matInput
          formControlName="nombre"
          placeholder="Ej: Administración, Producción, etc."
        />
        @if (form.get('nombre')?.errors?.['required'] && form.get('nombre')?.touched) {
        <mat-error>El nombre es requerido</mat-error>
        } @if (form.get('nombre')?.errors?.['maxlength']) {
        <mat-error>El nombre no puede exceder 100 caracteres</mat-error>
        }
      </mat-form-field>

      <!-- Número del centro (solo en crear) -->
      @if (!isEdit) {
      <mat-form-field appearance="outline">
        <mat-label>Número del centro</mat-label>
        @if (requiredPrefix) {
        <span matTextPrefix class="prefix-readonly">{{ requiredPrefix }}</span>
        }
        <input
          matInput
          formControlName="numeroSufijo"
          type="text"
          [placeholder]="numeroPlaceholder"
        />
        <mat-icon matSuffix>tag</mat-icon>
        @if (form.get('numeroSufijo')?.errors?.['required'] && form.get('numeroSufijo')?.touched) {
        <mat-error>El número es requerido</mat-error>
        } @if (form.get('numeroSufijo')?.errors?.['pattern']) {
        <mat-error>Solo se permiten números enteros positivos</mat-error>
        } @if (requiredPrefix) {
        <mat-hint
          >El prefijo "{{ requiredPrefix }}" está bloqueado. Ingrese el número del
          subcentro</mat-hint
        >
        } @else {
        <mat-hint>Ingrese el número del centro de costo principal</mat-hint>
        }
      </mat-form-field>

      <!-- Nivel (solo lectura) -->
      <mat-form-field appearance="outline">
        <mat-label>Nivel</mat-label>
        <input matInput formControlName="nivel" readonly />
        <mat-icon matSuffix color="primary">layers</mat-icon>
      </mat-form-field>

      <!-- Tipo de centro (automático) -->
      <mat-form-field appearance="outline">
        <mat-label>Tipo de centro</mat-label>
        <input matInput [value]="getTipoLabel(form.get('tipo')?.value)" readonly />
        <mat-icon matSuffix color="accent">auto_awesome</mat-icon>
        <mat-hint>
          @if (form.get('nivel')?.value === 1) { Nivel 1: Acumulación (automático) } @else { Nivel
          {{ form.get('nivel')?.value }}: Movimiento (automático) }
        </mat-hint>
      </mat-form-field>

      <!-- Estado -->
      <mat-form-field appearance="outline">
        <mat-label>Estado</mat-label>
        <mat-select formControlName="estado">
          <mat-option [value]="1">Activo</mat-option>
          <mat-option [value]="0">Inactivo</mat-option>
        </mat-select>
      </mat-form-field>
      }

      <!-- Campos de solo lectura en modo edición -->
      @if (isEdit) {
      <mat-form-field appearance="outline">
        <mat-label>Número</mat-label>
        <input matInput formControlName="numero" readonly />
        <mat-icon matSuffix>tag</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Nivel</mat-label>
        <input matInput formControlName="nivel" readonly />
        <mat-icon matSuffix color="primary">layers</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Tipo de centro</mat-label>
        <input matInput [value]="getTipoLabel(form.get('tipo')?.value)" readonly />
        <mat-icon matSuffix>label</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Estado</mat-label>
        <input matInput [value]="getEstadoLabel(form.get('estado')?.value)" readonly />
        <mat-icon matSuffix>toggle_on</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Código interno</mat-label>
        <input matInput formControlName="codigo" readonly />
        <mat-icon matSuffix>code</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Fecha de ingreso</mat-label>
        <input matInput [value]="formatDate(form.get('fechaIngreso')?.value)" readonly />
        <mat-icon matSuffix>schedule</mat-icon>
      </mat-form-field>
      }
    </div>

    <!-- Información del nivel (solo en crear) -->
    @if (!isEdit) {
    <div class="info-section">
      <div class="info-card">
        <div class="level-indicator">
          <mat-icon class="indicator-icon">layers</mat-icon>
          <span class="level-label">Nivel:</span>
          <span class="level-value">{{ form.get('nivel')?.value }}</span>
        </div>
      </div>
    </div>
    }

    <!-- Jerarquía visual (solo en crear con padre) -->
    @if (!isEdit && parentAccount) {
    <div class="hierarchy-section">
      <h4>Jerarquía</h4>
      <div class="hierarchy-tree">
        <div class="hierarchy-item parent">
          <mat-icon class="tree-icon">folder</mat-icon>
          <span>{{ buildParentCode() }} - {{ parentAccount.nombre }}</span>
        </div>
        <div class="hierarchy-connector">
          <mat-icon class="connector-icon">subdirectory_arrow_right</mat-icon>
        </div>
        <div class="hierarchy-item child">
          <mat-icon class="tree-icon">description</mat-icon>
          <span>
            {{ form.get('numero')?.value || '[Número]' }} -
            {{ form.get('nombre')?.value || '[Nombre del centro]' }}
          </span>
        </div>
      </div>
    </div>
    }

    <!-- Acciones del formulario -->
    <div class="form-actions">
      <button mat-button type="button" (click)="onCancel()" class="cancel-button">Cancelar</button>
      <button
        mat-flat-button
        color="primary"
        type="submit"
        [disabled]="form.invalid || loading"
        class="submit-button"
      >
        @if (loading) {
        <mat-spinner diameter="20" class="inline-spinner"></mat-spinner>
        } @else {
        <mat-icon class="button-icon">{{ isEdit ? 'save' : 'add' }}</mat-icon>
        }
        {{ isEdit ? 'Actualizar' : 'Crear' }} Centro
      </button>
    </div>
  </form>
</div>
