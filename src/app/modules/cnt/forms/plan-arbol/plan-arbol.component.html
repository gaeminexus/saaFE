<div class="plan-arbol-container">
  <!-- Header con controles -->
  <div class="header-section">
    <div class="title-section">
      <h2>Plan de Cuentas</h2>
      <p class="subtitle">Gesti칩n jer치rquica del cat치logo de cuentas contables</p>
    </div>

    <div class="actions-section">
      <button mat-flat-button color="primary" (click)="onAdd()" class="add-button">
        <mat-icon>add</mat-icon>
        Nueva Cuenta
      </button>

      <button mat-stroked-button (click)="toggleViewMode()" class="view-toggle">
        <mat-icon>{{ viewMode === 'tree' ? 'view_list' : 'account_tree' }}</mat-icon>
        {{ viewMode === 'tree' ? 'Vista Lista' : 'Vista 츼rbol' }}
      </button>

      <div class="export-buttons">
        <button mat-button (click)="exportToCSV()" class="export-button">
          <mat-icon>file_download</mat-icon>
          CSV
        </button>

        <button mat-button (click)="exportToPDF()" class="export-button">
          <mat-icon>picture_as_pdf</mat-icon>
          PDF
        </button>
      </div>
    </div>
  </div>

  <!-- Filtros y cuenta destino -->
  @if (viewMode === 'tree') {
    <div class="filters-bar">
      <mat-form-field
        appearance="outline"
        class="cuenta-destino-field"
        style="width: 200px; min-width: 160px"
      >
        <mat-label>Cuenta destino</mat-label>
        <input matInput type="text" [value]="previewCuentaDestino" readonly />
        <mat-icon matPrefix>account_balance</mat-icon>
      </mat-form-field>

      <!-- Filtro por Naturaleza (selector) -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Naturaleza</mat-label>
        <mat-select [(ngModel)]="selectedNaturaleza" (selectionChange)="onFilterChange()">
          <mat-option [value]="null">Todas</mat-option>
          @for (nat of naturalezas; track nat.codigo) {
            <mat-option [value]="nat.codigo">{{ nat.nombre }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- Filtro por Tipo de cuenta (selector) -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Tipo de cuenta</mat-label>
        <mat-select [(ngModel)]="selectedTipo" (selectionChange)="onFilterChange()">
          <mat-option [value]="null">Todos</mat-option>
          <mat-option [value]="1">{{ getTipoLabel(1) }}</mat-option>
          <mat-option [value]="2">{{ getTipoLabel(2) }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Filtro por N칰mero de cuenta -->
      <mat-form-field appearance="outline" class="filter-field search-field">
        <mat-label>N칰mero o Nombre de Cuenta</mat-label>
        <input
          matInput
          [(ngModel)]="numeroSearchText"
          (ngModelChange)="onNumeroSearchChange($event)"
          placeholder="Ej: 1.1, Caja, Bancos..."
        />
        <button
          mat-icon-button
          matSuffix
          *ngIf="numeroSearchText"
          (click)="numeroSearchText = ''; onNumeroSearchChange('')"
          matTooltip="Limpiar"
        >
          <mat-icon>close</mat-icon>
        </button>
        <mat-icon matSuffix>filter_alt</mat-icon>
      </mat-form-field>

      <!-- Controles de expansi칩n del 치rbol -->
      <div class="tree-expand-controls">
        <button
          mat-stroked-button
          color="primary"
          (click)="expandMatches()"
          matTooltip="Expandir coincidencias"
        >
          <mat-icon>zoom_in</mat-icon>
          Coincidencias
        </button>
        <button mat-stroked-button (click)="expandAll()" matTooltip="Expandir todo">
          <mat-icon>unfold_more</mat-icon>
          Expandir
        </button>
        <button mat-stroked-button (click)="collapseAll()" matTooltip="Colapsar todo">
          <mat-icon>unfold_less</mat-icon>
          Colapsar
        </button>
        <button
          mat-stroked-button
          (click)="clearFilters()"
          matTooltip="Limpiar filtros"
          class="clear-filters"
        >
          <mat-icon>clear_all</mat-icon>
          Limpiar
        </button>
      </div>
    </div>
  }

  <!-- Loading y Error -->
  @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando PlanArbol...</p>
    </div>
  }

  @if (error()) {
    <div class="error-container">
      <mat-icon>error</mat-icon>
      <p>{{ error() }}</p>
      <button mat-button (click)="loadData()">Reintentar</button>
    </div>
  }

  <!-- Vista 츼rbol -->
  @if (viewMode === 'tree' && !loading() && !error()) {
    <div class="tree-wrapper">
      <!-- Botones de navegaci칩n scroll -->
      @if (isScrolled()) {
        <div class="scroll-controls">
          <button mat-mini-fab color="primary" (click)="scrollToTop()" matTooltip="Ir arriba">
            <mat-icon>keyboard_arrow_up</mat-icon>
          </button>
          <button mat-mini-fab color="primary" (click)="scrollToLeft()" matTooltip="Ir al inicio">
            <mat-icon>keyboard_arrow_left</mat-icon>
          </button>
        </div>
      }

      <div class="tree-container" #treeContainer>
        <div class="tree-header">
          <div class="tree-title">
            <mat-icon>account_tree</mat-icon>
            <span>츼RBOL</span>
          </div>
        </div>

        <mat-tree [dataSource]="dataSource" [treeControl]="treeControl" class="plan-tree">
          <!-- Nodo hoja (nested para evitar mezcla de tipos) -->
          <mat-nested-tree-node
            *matTreeNodeDef="let node"
            [attr.data-level]="getLevel(node)"
            class="tree-node leaf-node"
          >
            <div
              class="node-content"
              [class.selected]="selectedNode === node"
              [style.padding-left]="getLevel(node) * 40 + 10 + 'px'"
              (click)="selectNode(node)"
            >
              <div class="node-spacer"></div>
              <span class="node-icon">游늯</span>

              <div class="node-info">
                <div class="account-header">
                  <span class="account-number">{{ node.cuentaContable }}</span>
                  <span class="account-name">{{ node.nombre }}</span>
                  <span class="badge tipo">{{ getTipoLabel(node.tipo) }}</span>
                </div>
              </div>

              @if (showActions) {
                <div class="node-actions">
                  @if (canAddChild(node)) {
                    <button
                      mat-icon-button
                      (click)="onAdd(node)"
                      matTooltip="Agregar cuenta hija"
                      class="action-button add-child"
                    >
                      <mat-icon>add</mat-icon>
                    </button>
                  }
                  @if (canEdit(node)) {
                    <button
                      mat-icon-button
                      (click)="onEdit(node)"
                      matTooltip="Editar cuenta"
                      class="action-button edit"
                    >
                      <mat-icon>edit</mat-icon>
                    </button>
                  }
                  <button
                    mat-icon-button
                    (click)="onDelete(node)"
                    matTooltip="Eliminar cuenta"
                    class="action-button delete"
                    [disabled]="
                      !node.codigo ||
                      node.codigo === 0 ||
                      (node.children && node.children.length > 0)
                    "
                  >
                    <mat-icon>delete_outline</mat-icon>
                  </button>
                </div>
              }
            </div>
          </mat-nested-tree-node>

          <!-- Nodo expandible (nested) -->
          <mat-nested-tree-node
            *matTreeNodeDef="let node; when: hasChild"
            class="tree-node expandable-node"
            [attr.data-level]="getLevel(node)"
          >
            <div
              class="node-content"
              [class.selected]="selectedNode === node"
              [style.padding-left]="getLevel(node) * 40 + 10 + 'px'"
            >
              <button
                mat-icon-button
                matTreeNodeToggle
                [attr.aria-label]="'Toggle ' + node.nombre"
                class="expand-button"
                [class.expanded]="treeControl.isExpanded(node)"
              >
                <mat-icon>{{
                  treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right'
                }}</mat-icon>
              </button>

              <span
                class="node-icon"
                [class.expanded]="treeControl.isExpanded(node)"
                (click)="selectNode(node); treeControl.toggle(node)"
                role="button"
              >
                {{ treeControl.isExpanded(node) ? '游늭' : '游늬' }}
              </span>

              <div
                class="node-info"
                (click)="selectNode(node); treeControl.toggle(node)"
                role="button"
              >
                <div class="account-header">
                  <span class="account-number">{{ node.cuentaContable }}</span>
                  <span class="account-name">{{ node.nombre }}</span>
                  <span class="badge tipo">{{ getTipoLabel(node.tipo) }}</span>
                </div>
              </div>

              @if (showActions) {
                <div class="node-actions">
                  @if (canAddChild(node)) {
                    <button
                      mat-icon-button
                      (click)="onAdd(node)"
                      matTooltip="Agregar cuenta hija"
                      class="action-button add-child"
                    >
                      <mat-icon>add</mat-icon>
                    </button>
                  }
                  @if (canEdit(node)) {
                    <button
                      mat-icon-button
                      (click)="onEdit(node)"
                      matTooltip="Editar cuenta"
                      class="action-button edit"
                    >
                      <mat-icon>edit</mat-icon>
                    </button>
                  }
                  <button
                    mat-icon-button
                    (click)="onDelete(node)"
                    matTooltip="Eliminar cuenta"
                    class="action-button delete"
                    [disabled]="
                      !node.codigo ||
                      node.codigo === 0 ||
                      (node.children && node.children.length > 0)
                    "
                  >
                    <mat-icon>delete_outline</mat-icon>
                  </button>
                </div>
              }
            </div>

            <!-- Contenedor donde se renderizan los hijos -->
            <div [class.hidden]="!treeControl.isExpanded(node)">
              <ng-container matTreeNodeOutlet></ng-container>
            </div>
          </mat-nested-tree-node>
        </mat-tree>
      </div>
    </div>
  }

  <!-- Vista Lista -->
  @if (viewMode === 'list' && !loading() && !error()) {
    <div class="table-container">
      <!-- Barra de filtros en vista lista -->
      <div class="filters-bar">
        <!-- Filtro por Naturaleza (selector) en vista lista -->
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Naturaleza</mat-label>
          <mat-select [(ngModel)]="selectedNaturaleza" (selectionChange)="onFilterChange()">
            <mat-option [value]="null">Todas</mat-option>
            @for (nat of naturalezas; track nat.codigo) {
              <mat-option [value]="nat.codigo">{{ nat.nombre }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <!-- Filtro por Tipo de cuenta (selector) en vista lista -->
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Tipo de cuenta</mat-label>
          <mat-select [(ngModel)]="selectedTipo" (selectionChange)="onFilterChange()">
            <mat-option [value]="null">Todos</mat-option>
            <mat-option [value]="1">{{ getTipoLabel(1) }}</mat-option>
            <mat-option [value]="2">{{ getTipoLabel(2) }}</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Filtro por N칰mero de cuenta en vista lista -->
        <mat-form-field appearance="outline" class="filter-field search-field">
          <mat-label>N칰mero de cuenta</mat-label>
          <input
            matInput
            [(ngModel)]="numeroSearchText"
            (ngModelChange)="onNumeroSearchChange($event)"
            placeholder="Ej: 1, 1.1, 1101..."
          />
          <button
            mat-icon-button
            matSuffix
            *ngIf="numeroSearchText"
            (click)="numeroSearchText = ''; onNumeroSearchChange('')"
            matTooltip="Limpiar"
          >
            <mat-icon>close</mat-icon>
          </button>
          <mat-icon matSuffix>filter_alt</mat-icon>
        </mat-form-field>
      </div>

      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th (click)="onSort('cuentaContable')" class="sortable-header">
                N칰mero
                <mat-icon>{{ getSortIcon('cuentaContable') }}</mat-icon>
              </th>
              <th (click)="onSort('nombre')" class="sortable-header">
                Nombre
                <mat-icon>{{ getSortIcon('nombre') }}</mat-icon>
              </th>
              <th>Naturaleza</th>
              <th>Nivel</th>
              <th>Estado</th>
              <th class="actions-header">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (item of pagedData; track trackByCodigo($index, item)) {
              <tr>
                <td>
                  <span class="account-number">{{ item.cuentaContable }}</span>
                </td>
                <td>
                  <span
                    class="account-name"
                    [style.margin-left]="((item.level || 1) - 1) * 16 + 'px'"
                  >
                    {{ item.nombre }}
                  </span>
                </td>
                <td>
                  <span class="badge naturaleza">{{
                    getNaturalezaName(item.naturalezaCuenta.codigo)
                  }}</span>
                </td>
                <td>
                  <span class="level-badge">{{ item.level }}</span>
                </td>
                <td>
                  <span
                    class="badge"
                    [class.estado-activo]="item.estado === 1"
                    [class.estado-inactivo]="item.estado !== 1"
                  >
                    {{ estadoLabel(item.estado) }}
                  </span>
                </td>
                <td class="actions-cell">
                  <button
                    mat-icon-button
                    (click)="onAdd(item)"
                    matTooltip="Agregar cuenta hija"
                    class="action-button add-child"
                  >
                    <mat-icon>add_circle_outline</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    (click)="onEdit(item)"
                    matTooltip="Editar cuenta"
                    class="action-button edit"
                  >
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    (click)="onDelete(item)"
                    matTooltip="Eliminar cuenta"
                    class="action-button delete"
                    [disabled]="
                      !item.codigo ||
                      item.codigo === 0 ||
                      (item.children && item.children.length > 0)
                    "
                  >
                    <mat-icon>delete_outline</mat-icon>
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Paginaci칩n -->
      @if (totalElements > pageSize) {
        <mat-paginator
          [length]="totalElements"
          [pageSize]="pageSize"
          [pageIndex]="pageIndex"
          [pageSizeOptions]="pageSizeOptions"
          [showFirstLastButtons]="true"
          (page)="onPageChange($event)"
          class="paginator"
        >
        </mat-paginator>
      }
    </div>
  }

  <!-- Mensaje cuando no hay datos -->
  @if (!loading() && !error() && filteredData.length === 0) {
    <div class="no-data-container">
      <mat-icon>account_tree</mat-icon>
      <h3>No se encontraron cuentas</h3>
      <p>No hay cuentas que coincidan con los filtros aplicados</p>
      <button mat-flat-button color="primary" (click)="clearFilters()">Limpiar filtros</button>
    </div>
  }
</div>
