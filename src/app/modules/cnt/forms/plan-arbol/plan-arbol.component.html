<div class="plan-arbol-container">
  <!-- Header con controles -->
  <div class="header-section">
    <div class="title-section">
      <h2>PlanArbol</h2>
      <p class="subtitle">Gesti칩n jer치rquica del cat치logo de cuentas contables</p>
    </div>

    <div class="actions-section">
      <!-- Indicador de cuenta destino (solo lectura, se actualiza al seleccionar nodo) -->
      <mat-form-field appearance="outline" class="level-selector" *ngIf="viewMode === 'tree'">
        <mat-label>Cuenta destino</mat-label>
        <input matInput type="text" [value]="previewCuentaDestino" readonly>
      </mat-form-field>

      <button mat-flat-button color="primary" (click)="onAdd()" class="add-button">
        <mat-icon>add</mat-icon>
        Nueva Cuenta
      </button>

      <button mat-stroked-button (click)="toggleViewMode()" class="view-toggle">
        <mat-icon>{{ viewMode === 'tree' ? 'list' : 'account_tree' }}</mat-icon>
        {{ viewMode === 'tree' ? 'Vista Lista' : 'Vista 츼rbol' }}
      </button>

      <button mat-button (click)="exportToCSV()" class="export-button">
        <mat-icon>file_download</mat-icon>
        CSV
      </button>

      <button mat-button (click)="exportToPDF()" class="export-button">
        <mat-icon>picture_as_pdf</mat-icon>
        PDF
      </button>
    </div>
  </div>



  <!-- Loading y Error -->
  @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando PlanArbol...</p>
    </div>
  }

  @if (error()) {
    <div class="error-container">
      <mat-icon>error</mat-icon>
      <p>{{ error() }}</p>
      <button mat-button (click)="loadData()">Reintentar</button>
    </div>
  }

  <!-- Vista 츼rbol -->
  @if (viewMode === 'tree' && !loading() && !error()) {
    <div class="tree-wrapper">
      <!-- Botones de navegaci칩n scroll -->
      @if (isScrolled()) {
        <div class="scroll-controls">
          <button mat-mini-fab color="primary" (click)="scrollToTop()" matTooltip="Ir arriba">
            <mat-icon>keyboard_arrow_up</mat-icon>
          </button>
          <button mat-mini-fab color="primary" (click)="scrollToLeft()" matTooltip="Ir al inicio">
            <mat-icon>keyboard_arrow_left</mat-icon>
          </button>
        </div>
      }

      <div class="tree-container" #treeContainer>
      <div class="tree-header">
        <div class="tree-title">
          <mat-icon>account_tree</mat-icon>
          <span>츼RBOL</span>
        </div>
      </div>

      <mat-tree [dataSource]="dataSource" [treeControl]="treeControl" class="plan-tree">

        <!-- Nodo hoja (nested para evitar mezcla de tipos) -->
        <mat-nested-tree-node *matTreeNodeDef="let node"
                               [style.padding-left]="(getLevel(node) * 20) + 'px'"
                               class="tree-node leaf-node">
          <div class="node-content" [class.selected]="selectedNode === node" (click)="selectNode(node)">
            <div class="node-spacer"></div>
            <span class="node-icon">游늯</span>

            <div class="node-info">
              <div class="account-header">
                <span class="account-number">{{ node.cuentaContable }}</span>
                <span class="account-name">{{ node.nombre }}</span>
              </div>
            </div>

            @if (showActions) {
            <div class="node-actions">
              @if (canAddChild(node)) {
                <button mat-icon-button (click)="onAdd(node)"
                        matTooltip="Agregar cuenta hija"
                        class="action-button add-child">
                  <mat-icon>add</mat-icon>
                </button>
              }
              @if (canEdit(node)) {
                <button mat-icon-button (click)="onEdit(node)"
                        matTooltip="Editar cuenta"
                        class="action-button edit">
                  <mat-icon>edit</mat-icon>
                </button>
              }
            </div>
            }
          </div>
        </mat-nested-tree-node>

        <!-- Nodo expandible (nested) -->
        <mat-nested-tree-node *matTreeNodeDef="let node; when: hasChild" class="tree-node expandable-node"
                               [style.padding-left]="(getLevel(node) * 20) + 'px'">
          <div class="node-content" [class.selected]="selectedNode === node">
            <button mat-icon-button matTreeNodeToggle
                    [attr.aria-label]="'Toggle ' + node.nombre"
                    class="expand-button"
                    [class.expanded]="treeControl.isExpanded(node)">
              <mat-icon>{{ treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right' }}</mat-icon>
            </button>

            <span class="node-icon" [class.expanded]="treeControl.isExpanded(node)"
                  (click)="selectNode(node); treeControl.toggle(node)" role="button">
              {{ treeControl.isExpanded(node) ? '游늭' : '游늬' }}
            </span>

            <div class="node-info" (click)="selectNode(node); treeControl.toggle(node)" role="button">
              <div class="account-header">
                <span class="account-number">{{ node.cuentaContable }}</span>
                <span class="account-name">{{ node.nombre }}</span>
              </div>
            </div>

            @if (showActions) {
            <div class="node-actions">
              @if (canAddChild(node)) {
                <button mat-icon-button (click)="onAdd(node)"
                        matTooltip="Agregar cuenta hija"
                        class="action-button add-child">
                  <mat-icon>add</mat-icon>
                </button>
              }
              @if (canEdit(node)) {
                <button mat-icon-button (click)="onEdit(node)"
                        matTooltip="Editar cuenta"
                        class="action-button edit">
                  <mat-icon>edit</mat-icon>
                </button>
              }
            </div>
            }
          </div>

          <!-- Contenedor donde se renderizan los hijos -->
          <div [class.hidden]="!treeControl.isExpanded(node)">
            <ng-container matTreeNodeOutlet></ng-container>
          </div>
        </mat-nested-tree-node>
      </mat-tree>
    </div>
    </div>
  }

  <!-- Vista Lista -->
  @if (viewMode === 'list' && !loading() && !error()) {
    <div class="table-container">
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th (click)="onSort('cuentaContable')" class="sortable-header">
                N칰mero
                <mat-icon>{{ getSortIcon('cuentaContable') }}</mat-icon>
              </th>
              <th (click)="onSort('nombre')" class="sortable-header">
                Nombre
                <mat-icon>{{ getSortIcon('nombre') }}</mat-icon>
              </th>
              <th>Naturaleza</th>
              <th>Nivel</th>
              <th>Estado</th>
              <th class="actions-header">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (item of pagedData; track trackByCodigo($index, item)) {
              <tr>
                <td>
                  <span class="account-number">{{ item.cuentaContable }}</span>
                </td>
                <td>
                  <span class="account-name"
                        [style.margin-left]="((item.level || 1) - 1) * 16 + 'px'">
                    {{ item.nombre }}
                  </span>
                </td>
                <td>
                  <span class="badge naturaleza">{{ getNaturalezaName(item.naturalezaCuenta.codigo) }}</span>
                </td>
                <td>
                  <span class="level-badge">{{ item.level }}</span>
                </td>
                <td>
                  <span class="badge" [class.estado-activo]="item.estado === 1"
                                    [class.estado-inactivo]="item.estado !== 1">
                    {{ estadoLabel(item.estado) }}
                  </span>
                </td>
                <td class="actions-cell">
                  <button mat-icon-button (click)="onAdd(item)"
                          matTooltip="Agregar cuenta hija"
                          class="action-button add-child">
                    <mat-icon>add_circle_outline</mat-icon>
                  </button>
                  <button mat-icon-button (click)="onEdit(item)"
                          matTooltip="Editar cuenta"
                          class="action-button edit">
                    <mat-icon>edit</mat-icon>
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Paginaci칩n -->
      @if (totalElements > pageSize) {
        <mat-paginator
          [length]="totalElements"
          [pageSize]="pageSize"
          [pageIndex]="pageIndex"
          [pageSizeOptions]="pageSizeOptions"
          [showFirstLastButtons]="true"
          (page)="onPageChange($event)"
          class="paginator">
        </mat-paginator>
      }
    </div>
  }

  <!-- Mensaje cuando no hay datos -->
  @if (!loading() && !error() && filteredData.length === 0) {
    <div class="no-data-container">
      <mat-icon>account_tree</mat-icon>
      <h3>No se encontraron cuentas</h3>
      <p>No hay cuentas que coincidan con los filtros aplicados</p>
      <button mat-flat-button color="primary" (click)="clearFilters()">
        Limpiar filtros
      </button>
    </div>
  }
</div>
